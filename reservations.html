<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reservations | Sista Sista Salon & Spa</title>
  <script src="auth.js"></script>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="icon" href="assets/icons/icon-192.png" type="image/png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    .user-profile{position:relative;display:inline-block;margin-top:8px;margin-right:50px;margin-left:30px}
    .user-icon{cursor:pointer;color:#000}
    .user-dropdown{display:none;position:absolute;background-color:#fff;min-width:50px;box-shadow:0 3px 6px rgba(0,0,0,.2);z-index:1;border-radius:8px;padding:10px}
    body.dark .user-dropdown{background-color:#444;color:#fff}

    .toast-message{visibility:hidden;min-width:200px;margin-left:-100px;background:#333;color:#fff;text-align:center;border-radius:8px;padding:14px;position:fixed;z-index:1000;left:50%;bottom:30px;font-size:16px;transition:opacity .5s ease,bottom .5s ease;opacity:0}
    .toast-message.show{visibility:visible;opacity:1;bottom:60px}

    .timeline-hours{display:flex;flex-direction:column;border-left:2px solid #ccc;padding-left:40px;margin-top:1rem}
    .hour-block{position:relative;min-height:60px;border-bottom:1px solid #eee;padding-left:10px}
    .time-label{position:absolute;left:-60px;top:10px;font-weight:700;color:#333}
    .reservation-card{margin-top:8px;background:#f9f9f9;padding:8px 12px;border-radius:8px;display:inline-block;font-size:14px;color:#000;box-shadow:1px 1px 3px rgba(0,0,0,.05)}

    body.dark-mode .timeline-hours{border-left-color:#555}
    body.dark-mode .hour-block{border-bottom-color:#333}
    body.dark-mode .time-label{color:#ccc}
    body.dark-mode .reservation-card{background:#333;color:#fff;border:1px solid #555}

    /* Services checklist (same look as Clients page) */
    .form-wrapper-column{align-items:stretch}
    .form-card{align-items:stretch !important;text-align:left}
    .form-card > *{width:100%}
    .services-checklist{max-height:260px;overflow:auto;border:1px solid #ddd;padding:10px;border-radius:10px;background:#fafafa;margin:0}
    .services-checklist details{margin:6px 0}
    .services-checklist summary{cursor:pointer;font-weight:600}
    .services-checklist label{display:block;margin:6px 0}
    .icon-actions i{vertical-align:middle}
  </style>
</head>
<body>
<script>
  const user = JSON.parse(localStorage.getItem("loggedUser"));
  if (!user || !user.role) { window.location.href = "index.html"; }
</script>

<div class="dashboard-container">
  <aside class="sidebar">
    <div class="sidebar-logo">
      <img src="assets/sista-sista-logo.png" alt="Sista Sista Logo" />
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
      <a href="clients.html"><i class="fas fa-users"></i> Clients</a>
      <a href="services.html"><i class="fas fa-scissors"></i> Services</a>
      <a href="notepad.html"><i class="fas fa-note-sticky"></i> Notepad</a>
      <a href="reviews.html"><i class="fa fa-comments"></i> Reviews</a>
      <a href="reservations.html" class="active"><i class="fas fa-calendar-check"></i> Bookings</a>
      <a href="reports.html"><i class="fas fa-chart-line"></i> Reports</a>
      <a href="revenue.html" class="active"><i class="fa fa-table"></i> Revenue Summary</a>
      <a href="index.html"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <div class="dashboard-header">
      <div class="theme-toggle-wrapper">
        <span>Dark Theme</span>
        <label class="theme-switch">
          <input type="checkbox" id="toggleDark" />
          <span class="slider"></span>
        </label>
      </div>
      <div class="user-profile">
        <div class="user-icon" id="userIcon">
          <i class="fas fa-user-circle fa-2x"></i>
        </div>
        <div class="user-dropdown" id="userDropdown">
          <p id="loggedInUser">Loading...</p>
          <button onclick="logout()" style="margin-top: 10px; background-color: #000000; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer;">Logout</button>
        </div>
      </div>
    </div>

    <div class="dashboard-body">
      <div class="form-wrapper-column">
        <h2 class="form-heading">Make a Booking</h2>

        <form id="reservationForm" class="form-card" autocomplete="off">
          <input type="text" name="clientName" placeholder="Client Name" required />
          <input type="tel" name="phone" placeholder="Phone Number" required />

          <label style="display:block;margin:10px 0 6px;font-weight:600;">Services (pick one or more)</label>
          <div id="resServicesGroup" class="services-checklist" role="group" aria-label="Services">
            <!-- Populated from IndexedDB. Fallback content will be inserted via JS if DB is empty. -->
          </div>

          <input type="text" id="reservationDate" name="date" placeholder="Select Date" required />
          <input type="text" id="reservationTime" name="time" placeholder="Select Time" required />
          <button type="submit" class="btn">Save Booking</button>
        </form>
      </div>
    </div>

    <div class="timeline-wrapper" style="margin: 2rem 0;">
      <h3>Upcoming Bookings (Timeline View)</h3>

      <div class="share-toolbar" style="display:flex; justify-content:flex-end; gap:10px; margin:.5rem 0 1rem;">
        <button id="shareTodayBtn" type="button" class="btn" title="Share via email">
          <i class="fas fa-share"></i> Share via Email
        </button>
      </div>

      <div class="timeline-scroll">
        <div id="timelineHours" class="timeline-hours"></div>
      </div>
    </div>

    <div class="app-footer">
      &copy; 2025 Sista Sista Salon & Spa. All rights reserved.<br/>
      Built by <strong><a href="https://hanatechnologies.org/" target="_blank" style="color: inherit;">H-A-N-A Technologies</a></strong>
    </div>
  </main>
</div>

<div id="toast" class="toast-message">Reservation saved!</div>

<!-- Core app (timeline + delete + share live here) -->
<script src="app.js"></script>

<!-- Page-specific logic -->
<script>
  /* ---------- tiny toast helper ---------- */
  function showToast(message){
    const t=document.getElementById("toast");
    t.textContent=message;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"),3000);
  }

  /* ---------- dynamic services checklist (IndexedDB â†’ grouped <details>) ---------- */
  const FALLBACK_GROUPS = [
    { category:"Natural Hair", items:[
      "Shampoo & Conrow","Detangling Shampoo Blowout","Natural Ponytail Hair No Silk Press","Silk Press",
      "Conditioning Treatment","Dandruff Treatment","Olapex Breakage Treatment","K18 Treatment",
      "Wig sew in(closure)","Wig sew in(frontal)","Wig revamp(shampooing+curling)","Wig revamp(shampooing+straight)",
      "Wig install ( frontal) sticking","Relax cut & style( pixie)","Shampoo & style (short hair)","Wig straightening or curling of weaves"
    ]},
    { category:"Relaxed Hair", items:[
      "Shampoo+Blow Drying+Straightening","Shampoo+roller setting","Shampoo & Conrows",
      "Relaxer+blowdrying+straightening(salon cream)one","Relaxer+Rollerset one & half(salon cream)",
      "Relaxer+blowdrying+straightening one & half","Relaxer two (salon cream)","Relaxer+blowouts one & half(salon cream)",
      "Relaxer+roller setting(personal cream)","Relaxer+blowdrying+straightening(personal cream)",
      "Own relaxer without shampoo & conditioner","Extra","Trimming","Cutting","Other Con-rows",
      "Conditioning treatment","Dandruff treatment","Olaplex Breakage treatment","K18 Treatment","Traditional sew in",
      "Closure sew in","Tracks glue","Tracks sew in","Relaxed hair ponytail","Relaxer front & back"
    ]},
    { category:"Nails", items:[
      "Pedicure & No polish","Pedicure + Regular polish","Pedicure + Gel polish","Pedicure + Acrylic on toes","Pedicure + stick on",
      "Pedicure stick on + French","Extra for French tips","Jelly Pedicure & Gel polish","Pedicure men","Manicure",
      "Regular Polish","Basic Gel polish","BIAB / Structured Gel polish","Hard Gel + Gel polish","Acrylic Full nails",
      "Acrylic nails on toes","Acrylic on toes refill","Acrylic refill (did full set with us)","Acrylic refill ( did not do full set with us)",
      "Stick on/ Gel polish","Dissolving","Dissolving + Manicure"
    ]},
    { category:"Waxing", items:[
      "Eyebrow Wax","Chin Wax","Chest Wax","Eyebrow shaping","Upper lip","Under arm","Stomach","Full arm","Half arm",
      "Half Legs","Full leg","Bikini area","Full Face","Hollywood wax"
    ]},
    { category:"Spa", items:[
      "Hot stone massage 1hr","Hot stone massage 1hr 30mins","Deep tissue massage 30mins","Deep tissue massage 1hr",
      "Deep tissue massage 1hr 30mins","Swedish massage 30mins","Swedish massage 1hr","Swedish massage 1hr 30mins",
      "Body Scrub","Steam Therapy","Back Treatment","Facials Deep cleanse","Facials Deep cleanse (upgrade)",
      "Facials Rejuvenation","Facials Anti acne","Facials Dermplane (Extra)"
    ]}
  ];

  async function readAllServicesFromDB(){
    return new Promise((resolve)=>{
      const req = indexedDB.open("SalonDB",1);
      req.onerror = () => resolve([]);
      req.onsuccess = (ev)=>{
        const idb = ev.target.result;
        if (!idb.objectStoreNames.contains("services")) { resolve([]); return; }
        const tx = idb.transaction("services","readonly");
        const store = tx.objectStore("services");
        const getAll = store.getAll();
        getAll.onsuccess = ()=> resolve(getAll.result || []);
        getAll.onerror = ()=> resolve([]);
      };
    });
  }

  function renderChecklist(targetId, groups){
    const host = document.getElementById(targetId);
    if (!host) return;
    host.innerHTML = "";
    groups.forEach(g=>{
      const det = document.createElement("details");
      det.open = true;
      const sum = document.createElement("summary");
      sum.textContent = g.category;
      det.appendChild(sum);
      (g.items || []).forEach(name=>{
        const lbl = document.createElement("label");
        lbl.innerHTML = `<input type="checkbox" value="${name}"> ${name}`;
        det.appendChild(lbl);
      });
      host.appendChild(det);
    });
  }

  async function buildServicesChecklist(){
    const rows = await readAllServicesFromDB();
    if (!rows.length){
      // fallback to your previous hardcoded list
      renderChecklist("resServicesGroup", FALLBACK_GROUPS);
      return;
    }
    // group by category
    const map = new Map();
    rows.forEach(r=>{
      const cat = (r.category || "Other").trim();
      const name = (r.name || "").trim();
      if (!name) return;
      if (!map.has(cat)) map.set(cat, new Set());
      map.get(cat).add(name);
    });
    const groups = Array.from(map.entries())
      .sort((a,b)=>a[0].localeCompare(b[0]))
      .map(([category, set]) => ({ category, items: Array.from(set).sort((a,b)=>a.localeCompare(b)) }));
    renderChecklist("resServicesGroup", groups);
  }

  // refresh when services page broadcasts updates
  (function wireServicesBroadcast(){
    if (typeof BroadcastChannel === "undefined") return;
    const ch = new BroadcastChannel("services");
    ch.onmessage = (e)=>{
      if (e?.data?.type === "services-updated") buildServicesChecklist();
    };
  })();

  /* ---------- reservation form helpers ---------- */
  function getSelectedServices() {
    const checks = document.querySelectorAll('#resServicesGroup input[type="checkbox"]:checked');
    return Array.from(checks).map(cb => cb.value.trim()).filter(Boolean);
  }

  function to24h(t=""){
    t=t.trim();
    if(/am|pm/i.test(t)){
      const m=t.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
      if(!m) return "00:00";
      let hh=parseInt(m[1],10); const mm=m[2]; const pm=m[3].toUpperCase()==="PM";
      if(hh===12 && !pm) hh=0;
      if(hh<12 && pm) hh+=12;
      return String(hh).padStart(2,"0")+":"+mm;
    }
    return t;
  }
  function localTimestamp(dateStr="", timeStr="00:00"){
    const [y,m,d]=dateStr.split("-").map(Number);
    const [H,M]=to24h(timeStr).split(":").map(Number);
    if(!(y&&m&&d)) return 0;
    return new Date(y,m-1,d,H||0,M||0,0,0).getTime();
  }

  // Save reservation (keeps your existing data shape)
  document.addEventListener("DOMContentLoaded", ()=>{
    const form = document.getElementById("reservationForm");
    form.addEventListener("submit", function(e){
      e.preventDefault();

      const services = getSelectedServices();
      if (services.length === 0) { showToast("Pick at least one service."); return; }

      const date=form.date.value.trim();
      const time=form.time.value.trim();
      const time24=to24h(time);
      const timestamp=localTimestamp(date,time);

      const reservation={
        clientName: form.clientName.value.trim(),
        phone: form.phone.value.trim(),
        services,                           // array
        service: services.join(", "),       // legacy text field (for old readers)
        date, time, time24, timestamp,
        createdAt: new Date().toISOString()
      };

      const req=indexedDB.open("SalonDB",1);
      req.onsuccess=function(ev){
        const _db=ev.target.result;
        const tx=_db.transaction("reservations","readwrite");
        tx.objectStore("reservations").add(reservation);
        tx.oncomplete=()=>{
          showToast("Reservation saved!");
          form.reset();

          // refresh timeline (provided by app.js)
          if (typeof loadTimelineHoursWithReservations==="function") loadTimelineHoursWithReservations();

          // notify other tabs/pages
          if (typeof BroadcastChannel!=="undefined")
            new BroadcastChannel("reservations").postMessage({type:"update", from:"reservations-page"});
        };
        tx.onerror=()=>showToast("Error saving reservation.");
      };
    });
  });

  // Dark Mode toggle
  const toggleDark=document.getElementById("toggleDark");
  toggleDark.addEventListener("change",function(){document.body.classList.toggle("dark-mode",this.checked);});

  function logout() {
    sessionStorage.removeItem("sista_session");
    localStorage.removeItem("role");
    localStorage.removeItem("username");
    localStorage.removeItem("loggedUser");
    window.location.replace("index.html");
  }
</script>

<!-- Flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  document.addEventListener("DOMContentLoaded", async () => {
    // Date/time pickers
    if (window.flatpickr) {
      flatpickr("#reservationDate",{dateFormat:"Y-m-d",minDate:"today"});
      flatpickr("#reservationTime",{enableTime:true,noCalendar:true,dateFormat:"h:i K",time_24hr:false});
    } else {
      document.getElementById("reservationDate")?.setAttribute("type","date");
      document.getElementById("reservationTime")?.setAttribute("type","time");
    }

    // Build services checklist now
    await buildServicesChecklist();

    // Ensure timeline renders (app.js does the heavy lifting)
    if (typeof wireReservationsPage === "function") wireReservationsPage();
  });
</script>
</body>
</html>
