<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Fullscreen on iPad (uses the whole safe area) -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Login | Sista Sista Salon & Spa</title>

  <!-- iOS / PWA meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Sista Sista Salon">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#ffffff" />

  <!-- Manifest -->
  <link rel="manifest" href="./manifest.json" type="application/manifest+json">

  <!-- App Icons (iOS picks best size) -->
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/icon-180.png?v=1">
  <link rel="apple-touch-icon" sizes="167x167" href="assets/icons/icon-167.png?v=1">
  <link rel="apple-touch-icon" sizes="152x152" href="assets/icons/icon-152.png?v=1">
  <!-- Fallback favicon for browsers -->
  <link rel="icon" href="assets/icons/icon-192.png" type="image/png">

  <!-- Splash Screens for iPad Pro 13″ (1032×1376 @2x) -->
  <link rel="apple-touch-startup-image" href="assets/splash/splash-2064x2752.png"
        media="(device-width: 1032px) and (device-height: 1376px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="assets/splash/splash-2752x2064.png"
        media="(device-width: 1032px) and (device-height: 1376px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">

  <!-- Splash Screens for iPad Pro 12.9″ (1024×1366 @2x) -->
  <link rel="apple-touch-startup-image" href="assets/splash/splash-2048x2732.png"
        media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="assets/splash/splash-2732x2048.png"
        media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">

  <!-- Styles -->
  <link rel="stylesheet" href="login.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Minimal modal + helper styles -->
  <style>
    .setup-modal-backdrop,
    .confirm-modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.45);
      display: none; align-items: center; justify-content: center; z-index: 9999;
    }
    .setup-modal, .confirm-modal {
      width: min(520px, 92vw); background: #fff; border-radius: 14px; padding: 20px 22px;
      box-shadow: 0 10px 30px rgba(0,0,0,.2); color:#222; font-family: system-ui, -apple-system, Arial, sans-serif;
    }
    .setup-modal h3, .confirm-modal h3 { margin: 0 0 10px; font-size: 20px; }
    .setup-modal p,  .confirm-modal p  { margin: 0 0 14px; color:#555; }
    .setup-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .setup-modal label, .confirm-modal label { display:block; font-size: 13px; margin-bottom: 6px; color:#333; }
    .setup-modal input, .confirm-modal input, .setup-modal select {
      width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;
    }
    .setup-actions, .confirm-actions { display:flex; gap:10px; justify-content:flex-end; margin-top: 16px; }
    .btn-plain { background:#eee; border:0; border-radius: 10px; padding:10px 14px; cursor:pointer; }
    .btn-main  { background:#000; color:#fff; border:0; border-radius: 10px; padding:10px 14px; cursor:pointer; }
    .btn-danger{ background:#aa2626; color:#fff; border:0; border-radius: 10px; padding:10px 14px; cursor:pointer; }
    .setup-note { font-size: 12px; color:#777; margin-top: 6px; }
    .reset-link { text-align:center; margin-top:12px; }
    .reset-link a { color:#888; text-decoration: none; font-size: 12px; }
    .reset-link a:hover { text-decoration: underline; color:#000; }

    @media (max-width: 560px) { .setup-grid { grid-template-columns: 1fr; } }

    /* Toast */
    #toast {
      position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(8px);
      background:#111;color:#fff;padding:12px 16px;border-radius:12px;font-weight:600;
      box-shadow:0 8px 24px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:.25s;z-index:10000;
    }
  </style>
</head>

<body>
  <div class="login-wrapper">
    <div class="login-image">
      <img src="assets/sista-sista-home.jpeg" alt="Sista Sista Salon" />
    </div>

    <div class="login-form-box">
      <div class="login-box">
        <div style="text-align: center; margin-bottom: 20px;">
          <img src="assets/sista-sista-logo.png" alt="Sista Sista Logo" style="max-width: 180px;">
          <p style="margin-top: 10px; font-size: 20px; font-weight: bold; color: #333;">Login to manage Salon</p>
        </div>

        <form id="loginForm">
          <input type="text" id="username" placeholder="Username" required />
          <div class="password-wrapper">
            <input type="password" id="password" placeholder="PIN" required />
            <i class="fas fa-eye toggle-password" onclick="togglePassword()"></i>
          </div>

          <select id="role" required>
            <option value="">Select Role</option>
            <option value="admin">Admin</option>
            <option value="staff">Staff</option>
          </select>

          <button type="submit">Login</button>
        </form>

        <p id="loginError" style="display: none; color: red; text-align: center; margin-top: 10px;">
          Invalid credentials.
        </p>

        <!-- Reset PINs link -->
        <div class="reset-link">
          <a href="#" id="resetPinsLink" title="Clear saved users and re-run setup">Reset PINs</a>
        </div>
      </div>
    </div>
  </div>

  <!-- First-run Setup Modal -->
  <div id="setupBackdrop" class="setup-modal-backdrop" aria-hidden="true">
    <div class="setup-modal" role="dialog" aria-modal="true" aria-labelledby="setupTitle">
      <h3 id="setupTitle">First-time Setup</h3>
      <p>Create an Admin account (required), plus an optional second Admin and an optional Staff account. PINs are stored securely on this device.</p>

      <!-- Admin 1 (required) -->
      <div class="setup-grid">
        <div>
          <label>Admin 1 Username</label>
          <input id="su_admin_user" type="text" placeholder="e.g. Owner" value="Owner">
        </div>
        <div>
          <label>Admin 1 PIN (min 4 digits)</label>
          <input id="su_admin_pin" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="••••">
        </div>
        <div>
          <label>Confirm Admin 1 PIN</label>
          <input id="su_admin_pin2" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="••••">
        </div>
      </div>

      <!-- Admin 2 (optional) -->
      <div class="setup-grid" style="margin-top:12px;">
        <div>
          <label>Admin 2 Username (optional)</label>
          <input id="su_admin2_user" type="text" placeholder="e.g. Co-Owner">
        </div>
        <div>
          <label>Admin 2 PIN (min 4 digits)</label>
          <input id="su_admin2_pin" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="••••">
        </div>
        <div>
          <label>Confirm Admin 2 PIN</label>
          <input id="su_admin2_pin2" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="••••">
        </div>
      </div>

      <!-- Staff (optional) -->
      <div class="setup-grid" style="margin-top:12px;">
        <div>
          <label>Staff Username (optional)</label>
          <input id="su_staff_user" type="text" placeholder="e.g. Staff">
        </div>
        <div>
          <label>Staff PIN (optional, min 4 digits)</label>
          <input id="su_staff_pin" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="••••">
        </div>
      </div>

      <div class="setup-actions">
        <button class="btn-plain" type="button" id="setupCancel">Cancel</button>
        <button class="btn-main"  type="button" id="setupSave">Save & Continue</button>
      </div>
      <div class="setup-note">Tip: You can change users later by clearing this device’s <code>localStorage["sista_users"]</code> and reloading.</div>
    </div>
  </div>

  <!-- Reset PINs Confirm Modal -->
  <div id="confirmBackdrop" class="confirm-modal-backdrop" aria-hidden="true">
    <div class="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <h3 id="confirmTitle">Reset PINs</h3>
      <p>Type <b>RESET</b> to clear all saved users and sessions on this device.</p>
      <input id="resetConfirmInput" type="text" placeholder="Type RESET to confirm">
      <div class="confirm-actions">
        <button class="btn-plain"  type="button" id="cancelResetBtn">Cancel</button>
        <button class="btn-danger" type="button" id="confirmResetBtn">Reset</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <script>
    /* ========= First-run PIN auth (PBKDF2 salted hashes) ========= */
    const USERS_KEY   = 'sista_users';   // [{username, role, salt:number[], hash:string, createdAt}]
    const SESSION_KEY = 'sista_session';

    function getUsers() {
      try { return JSON.parse(localStorage.getItem(USERS_KEY) || '[]'); }
      catch { return []; }
    }
    function saveUsers(list) { localStorage.setItem(USERS_KEY, JSON.stringify(list)); }
    function findUser(username, role) {
      const u = (getUsers() || []).find(x => x.username === username && x.role === role);
      return u || null;
    }
    function hasAdmin() { return (getUsers() || []).some(u => u.role === 'admin'); }

    async function deriveHash(pin, saltBytes, iterations = 150000) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(pin), 'PBKDF2', false, ['deriveBits']);
      const bits = await crypto.subtle.deriveBits(
        { name: 'PBKDF2', hash: 'SHA-256', salt: saltBytes, iterations },
        keyMaterial,
        256
      );
      return Array.from(new Uint8Array(bits)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function createUser(username, role, pin) {
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const hash = await deriveHash(pin, salt);
      const users = getUsers();
      if (users.some(u => u.username === username && u.role === role)) {
        throw new Error('User already exists');
      }
      users.push({ username, role, salt: Array.from(salt), hash, createdAt: Date.now() });
      saveUsers(users);
    }

    async function validateLogin(username, role, pin) {
      const user = findUser(username, role);
      if (!user) return false;
      const salt = new Uint8Array(user.salt);
      const hash = await deriveHash(pin, salt);
      return hash === user.hash;
    }

    function showSetupModal(show) {
      const el = document.getElementById('setupBackdrop');
      el.style.display = show ? 'flex' : 'none';
      el.setAttribute('aria-hidden', show ? 'false' : 'true');
    }

    async function ensureFirstRunSetup() {
      if (!hasAdmin()) showSetupModal(true);
    }

    /* ========= Toast ========= */
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = `Sista Sista: ${msg}`;
      t.style.opacity = 1;
      t.style.transform = 'translateX(-50%) translateY(0)';
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => {
        t.style.opacity = 0;
        t.style.transform = 'translateX(-50%) translateY(8px)';
      }, 2400);
    }

    /* ========= Reset PINs (modal) ========= */
    document.getElementById('resetPinsLink')?.addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('confirmBackdrop').style.display = 'flex';
      document.getElementById('confirmBackdrop').setAttribute('aria-hidden', 'false');
      const input = document.getElementById('resetConfirmInput');
      input.value = '';
      setTimeout(() => input.focus(), 0);
    });

    document.getElementById('cancelResetBtn')?.addEventListener('click', () => {
      document.getElementById('confirmBackdrop').style.display = 'none';
      document.getElementById('confirmBackdrop').setAttribute('aria-hidden', 'true');
    });

    document.getElementById('confirmResetBtn')?.addEventListener('click', () => {
      const v = document.getElementById('resetConfirmInput').value.trim().toUpperCase();
      if (v !== 'RESET') { showToast('Please type RESET to confirm'); return; }
      localStorage.removeItem(USERS_KEY);
      localStorage.removeItem('loggedUser');
      sessionStorage.removeItem(SESSION_KEY);
      document.getElementById('confirmBackdrop').style.display = 'none';
      showToast('PINs cleared on this device');
      setTimeout(() => { showSetupModal(true); }, 600);
    });

    /* ========= Setup modal buttons ========= */
    document.getElementById('setupCancel').addEventListener('click', () => {
      if (!hasAdmin()) { showToast('Please complete Admin setup to continue'); return; }
      showSetupModal(false);
    });

    document.getElementById('setupSave').addEventListener('click', async () => {
      // Admin 1 (required)
      const adminUser = document.getElementById('su_admin_user').value.trim() || 'Owner';
      const adminPin  = document.getElementById('su_admin_pin').value.trim();
      const adminPin2 = document.getElementById('su_admin_pin2').value.trim();

      // Admin 2 (optional)
      const admin2User = document.getElementById('su_admin2_user').value.trim();
      const admin2Pin  = document.getElementById('su_admin2_pin').value.trim();
      const admin2Pin2 = document.getElementById('su_admin2_pin2').value.trim();

      // Staff (optional)
      const staffUser = document.getElementById('su_staff_user').value.trim();
      const staffPin  = document.getElementById('su_staff_pin').value.trim();

      if (adminPin.length < 4) { showToast('Admin 1 PIN must be at least 4 digits'); return; }
      if (adminPin !== adminPin2) { showToast('Admin 1 PINs do not match'); return; }

      // If any Admin 2 field provided, validate fully
      const admin2Provided = admin2User || admin2Pin || admin2Pin2;
      if (admin2Provided) {
        if (!admin2User) { showToast('Admin 2 username is required'); return; }
        if (admin2Pin.length < 4) { showToast('Admin 2 PIN must be at least 4 digits'); return; }
        if (admin2Pin !== admin2Pin2) { showToast('Admin 2 PINs do not match'); return; }
      }

      // Staff validation if provided
      if (staffUser || staffPin) {
        if (!staffUser) { showToast('Staff username is required'); return; }
        if (staffPin.length < 4) { showToast('Staff PIN must be at least 4 digits'); return; }
      }

      try {
        await createUser(adminUser, 'admin', adminPin);
        if (admin2Provided) {
          await createUser(admin2User, 'admin', admin2Pin);
        }
        if (staffUser && staffPin) {
          await createUser(staffUser, 'staff', staffPin);
        }
        showSetupModal(false);
        showToast('Setup complete! You can now log in');
      } catch (e) {
        console.error(e);
        showToast(e.message || 'Could not save users');
      }
    });

    /* ========= Login handling ========= */
    document.getElementById("loginForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const username = document.getElementById("username").value.trim();
      const pin      = document.getElementById("password").value.trim();
      const role     = document.getElementById("role").value;

      const ok = await validateLogin(username, role, pin);
      if (ok) {
        const session = {
          user: { username, role },
          issuedAt: Date.now(),
          expiresAt: Date.now() + 8 * 60 * 60 * 1000
        };
        sessionStorage.setItem(SESSION_KEY, JSON.stringify(session));
        localStorage.setItem("loggedUser", JSON.stringify(session.user));
        const next = new URLSearchParams(location.search).get("next") || "dashboard.html";
        location.href = next;
      } else {
        document.getElementById("loginError").style.display = "block";
      }
    });

    function togglePassword() {
      const input = document.getElementById("password");
      const icon  = document.querySelector(".toggle-password");
      const show  = input.type === "password";
      input.setAttribute("type", show ? "text" : "password");
      icon.classList.toggle("fa-eye", !show);
      icon.classList.toggle("fa-eye-slash", show);
    }

    // Show setup if needed on load
    window.addEventListener('DOMContentLoaded', ensureFirstRunSetup);
  </script>

  <!-- Service Worker (relative paths for GitHub Pages project sites) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker
          .register('./sw.js', { scope: './' })
          .then(reg => console.log('✅ Service Worker registered at scope:', reg.scope))
          .catch(err => console.error('❌ SW registration failed:', err));
      });
    }
  </script>
</body>
</html>
