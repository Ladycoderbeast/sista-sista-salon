<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clients | Sista Sista Salon & Spa</title>
  <script src="auth.js"></script>

  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    .user-profile { position: relative; display: inline-block; margin-top: 8px; margin-right: 50px; margin-left: 30px; }
    .user-icon { cursor: pointer; color: #000; }
    .user-dropdown { display: none; position: absolute; background-color: white; min-width: 50px; box-shadow: 0 3px 6px rgba(0,0,0,0.2); z-index: 1; border-radius: 8px; padding: 10px; }
    body.dark .user-dropdown { background-color: #444; color: #fff; }

    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; background-color: rgba(0, 0, 0, 0.4); z-index: 1000; }

    .admin-only { display: table-cell; }
    body.staff .admin-only { display: none !important; }

    .client-list { max-height: 60vh; overflow-y: auto; }

    .toast { visibility: hidden; min-width: 200px; margin-left: -100px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 9999; left: 50%; bottom: 30px; font-size: 16px; opacity: 0; transition: opacity 0.5s ease-in-out, bottom 0.5s ease-in-out; }
    .toast.show { visibility: visible; opacity: 1; bottom: 50px; }

    .summary-cards { margin-top: 40px; display:grid; grid-template-columns: repeat(5,minmax(180px,1fr)); gap:14px; }
    .summary-card { display:flex; gap:12px; align-items:center; padding:16px; border-radius:14px; background:#fff; box-shadow:0 1px 6px rgba(0,0,0,.06); cursor:pointer; border:1px solid transparent; }
    .summary-card:hover { border-color:#000; }
    .summary-card i { font-size:20px; }
    .summary-card h3 { margin:0; }
    .summary-card p { margin:0; opacity:.7; }

    #imageModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 9999; }
    .main-content { width: 100%; overflow-x: hidden; padding: 1rem; box-sizing: border-box; }
    .table-wrapper { overflow-x: auto; width: 100%; }

    .clients-table { width: 100%; border-collapse: collapse; table-layout: fixed; word-wrap: break-word; }
    .clients-table th, .clients-table td { padding: 20px; text-align: left; white-space: normal; word-break: break-word; font-size: 14px; }

    /* Grouped services checklist - collapsible */
    .services-checklist {
      max-height: 260px; overflow: auto; border: 1px solid #ddd;
      padding: 10px; border-radius: 10px; background: #fafafa;
    }
    .services-checklist details { margin: 6px 0; }
    .services-checklist summary { cursor: pointer; font-weight: 600; }
    .services-checklist label { display:block; margin:6px 0; }

    /* small badge showing active filter */
    #activeCardFilter { font-size:12px; opacity:.7; margin-left:6px; }

    /* Make the Add Client modal panel scrollable */
#addClientModal {
  padding: 16px;                 /* a little breathing room around the card */
  align-items: center;           /* keep it centered vertically */
  justify-content: center;       /* keep it centered horizontally */
}

#addClientModal .form-card {
  max-height: 88vh;              /* never taller than the viewport */
  overflow: auto;                /* scroll inside the card if it gets long */
  display: flex;
  flex-direction: column;
}

/* Keep the services list from eating all the height */
#addClientModal .services-checklist {
  max-height: 40vh;              /* scroll just the checklist when expanded */
  overflow: auto;
}

/* Nice quality-of-life touches (optional) */
#addClientModal .form-card h3 {
  position: sticky; top: 0;
  background: inherit;           /* matches light/dark card bg */
  padding-bottom: 8px;
  z-index: 1;
}

/* If you ever add a .form-actions wrapper, make it stick too */
#addClientModal .form-actions {
  position: sticky; bottom: 0;
  background: inherit;
  padding-top: 10px;
}

  </style>
</head>

<body>
<script>
  const user = JSON.parse(localStorage.getItem("loggedUser"));
  if (!user || !user.role) { window.location.href = "index.html"; }
</script>

<div class="dashboard-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-logo">
      <img src="assets/sista-sista-logo.png" alt="Sista Sista Logo" />
    </div>
    <div class="sidebar-nav">
      <a href="dashboard.html"><i class="fa fa-home"></i> Dashboard</a>
      <a href="clients.html" class="active"><i class="fa fa-users"></i> Clients</a>
      <a href="services.html"><i class="fa fa-scissors"></i> Services</a>
      <a href="notepad.html"><i class="fas fa-note-sticky"></i> Notepad</a>
      <a href="reviews.html"><i class="fa fa-comments"></i> Reviews</a>
      <a href="reservations.html"><i class="fa fa-calendar"></i> Bookings</a>
      <a href="reports.html"><i class="fa fa-chart-line"></i> Reports</a>
      <a href="revenue.html" class="active"><i class="fa fa-table"></i> Revenue Summary</a>
      <a href="index.html"><i class="fa fa-sign-out-alt"></i> Logout</a>
    </div>
  </div>

  <!-- Main Content -->
  <main class="main-content">
    <div class="dashboard-header">
      <div class="theme-toggle-wrapper">
        <span>Dark Theme</span>
        <label class="theme-switch">
          <input type="checkbox" id="toggleDark" />
          <span class="slider"></span>
        </label>
      </div>
      <div class="user-profile">
        <div class="user-icon" id="userIcon">
          <i class="fas fa-user-circle fa-2x"></i>
        </div>
        <div class="user-dropdown" id="userDropdown">
          <p id="loggedInUser">Loading...</p>
          <button onclick="logout()" style="margin-top: 10px; background-color: #000000; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer;">Logout</button>
        </div>
      </div>
    </div>

    <!-- Summary cards (clickable) -->
    <div class="summary-cards" id="clientSummaryCards">
      <button class="summary-card" data-card-filter="total" type="button">
        <i class="fa fa-users"></i><div><h3 id="totalClientsCard">0</h3><p>Total Clients</p></div>
      </button>
      <button class="summary-card" data-card-filter="returning" type="button">
        <i class="fa fa-sync-alt"></i><div><h3 id="returningClients">0</h3><p>Returning Clients</p></div>
      </button>
      <button class="summary-card" data-card-filter="new" type="button">
        <i class="fa fa-star"></i><div><h3 id="newClients">0</h3><p>New Clients</p></div>
      </button>
      <button class="summary-card" data-card-filter="female" type="button">
        <i class="fa fa-female"></i><div><h3 id="femaleClients">0</h3><p>Female Clients</p></div>
      </button>
      <button class="summary-card" data-card-filter="male" type="button">
        <i class="fa fa-male"></i><div><h3 id="maleClients">0</h3><p>Male Clients</p></div>
      </button>
    </div>

    <div class="clients-wrapper">
      <button type="button" class="btn" onclick="openAddClientModal()">Add New Client</button>
      <div class="client-list">
        <!-- Tiny scope switch (Today / All) + Clear -->
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0 6px;">
          <div id="clientsScopeSwitch" style="display:flex; gap:12px; align-items:center;">
            <label><input type="radio" name="clientsScope" id="clientsScopeToday" value="today"> Today</label>
            <label><input type="radio" name="clientsScope" id="clientsScopeAll" value="all"> All</label>
            <button id="clearCardFilter" type="button" class="btn" style="padding:6px 10px;">Clear</button>
            <span id="activeCardFilter"></span>
          </div>
        </div>

        <div class="client-controls" style="margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
          <input type="text" id="clientSearchInput" placeholder="Search by name, phone, service or staff..." style="padding: 8px; flex: 1; min-width: 200px;" />
          <select id="serviceFilter" style="padding: 8px;">
            <option value="">All Services</option>
            <!-- dynamically filled -->
          </select>
          <button onclick="exportClientsCSV()" class="btn">Export CSV</button>
          <button onclick="exportClientsPDF()" class="btn">Export PDF</button>
          <button onclick="printClientsTable()" class="btn">Print</button>
        </div>

        <table class="clients-table" id="clientsTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Phone</th>
              <th>Gender</th>
              <th>Photo</th>
              <th>Service</th>
              <th>Date</th>
              <th>Time</th>
              <th>Staff</th>
              <th class="admin-only">Amount</th>
              <th class="admin-only">Payment</th>
              <th class="admin-only">Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
    </div>
  </main>
</div>

<!-- Footer -->
<div class="app-footer">
  &copy; 2025 Sista Sista Salon & Spa. All rights reserved.<br/>
  Built by <strong><a href="https://hanatechnologies.org/" target="_blank" style="color: inherit;">H-A-N-A Technologies</a></strong>
</div>

<!-- Add Client Modal -->
<div id="addClientModal" class="modal">
  <div class="form-card">
    <h3>Add New Client</h3>

    <input type="text" id="clientName" placeholder="Full Name" required />
    <input type="text" id="clientPhone" placeholder="Phone Number" required />

    <select id="clientGender">
      <option value="">Select Gender</option>
      <option value="Female">Female</option>
      <option value="Male">Male</option>
    </select>

    <!-- Services (dynamic; falls back to default if DB empty) -->
    <label style="display:block;margin:10px 0 6px;font-weight:600;">Services (pick one or more)</label>
    <div id="clientServicesGroup" class="services-checklist" role="group" aria-label="Services">
      <!-- Fallback will be injected by JS if DB has nothing -->
    </div>

    <input type="file" id="clientPhoto" accept="image/*" />
    <input type="number" id="clientAmount" placeholder="Amount Paid" />

    <select id="clientPaymentMethod" required>
      <option value="">Payment Method</option>
      <option value="Mobile Money">Mobile Money</option>
      <option value="Cash">Cash</option>
    </select>

    <input type="text" id="clientDate" name="date" placeholder="Select Date" required />
    <input type="text" id="clientTime" name="time" placeholder="Select Time" required />

    <!-- Staff -->
    <input type="text" id="clientStaff" placeholder="Staff (who attended)" required />

    <button class="btn" type="button" onclick="addClient()">Save Client</button>
    <button class="btn" type="button" onclick="closeAddClientModal()">Cancel</button>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Scripts -->
<script src="app.js"></script>
<script src="user-icon.js"></script>
<script>
  function openAddClientModal() {
    document.getElementById("addClientModal").style.display = "flex";
  }
  function closeAddClientModal() {
    document.getElementById("addClientModal").style.display = "none";
  }
</script>

<script>
  async function exportClientsPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const table = document.getElementById("clientsTable");
    const rows = [];
    const headers = [];

    table.querySelectorAll("thead th").forEach(th => headers.push(th.innerText.trim()));
    table.querySelectorAll("tbody tr").forEach(row => {
      const rowData = [];
      row.querySelectorAll("td").forEach(td => rowData.push(td.innerText.trim()));
      rows.push(rowData);
    });

    doc.autoTable({ head: [headers], body: rows, styles: { fontSize: 8 }, theme: 'grid' });
    doc.save("sista_sista_clients.pdf");
  }
</script>

<!-- Full Image Popup -->
<div id="imageModal" class="modal" onclick="this.style.display='none'">
  <img id="fullImage" style="max-width:90%;max-height:90%;border-radius:12px;" />
</div>
<script>
  function openFullImage(src) {
    const modal = document.getElementById('imageModal');
    const image = document.getElementById('fullImage');
    image.src = src;
    modal.style.display = 'flex';
  }
</script>

<script>
  const loggedUser = JSON.parse(localStorage.getItem("loggedUser"));
  if (loggedUser && loggedUser.role === "staff") {
    document.body.classList.add("staff");
  } else {
    document.body.classList.add("admin");
  }
</script>
<script>
  function logout() {
    sessionStorage.removeItem("sista_session");
    localStorage.removeItem("role");
    localStorage.removeItem("username");
    localStorage.removeItem("loggedUser");
    window.location.replace("index.html");
  }
</script>

<script>
  // Date & Time pickers
  flatpickr("#clientDate", { dateFormat: "Y-m-d" });
  flatpickr("#clientTime", { enableTime: true, noCalendar: true, dateFormat: "h:i K", time_24hr: false });

  /**
   * DYNAMIC SERVICES LOADER (safe for dashboard/reports)
   * - Reads `services` store: { id, category, name }
   * - Builds the checklist + the service filter
   * - Falls back to DEFAULT_SERVICES if DB is empty
   * - Refreshes when Services page broadcasts "servicesChanged"
   */
  const DEFAULT_SERVICES = [
    {category:"Natural Hair", items:[
      "Shampoo & Conrow","Detangling Shampoo Blowout","Natural Ponytail Hair No Silk Press","Silk Press","Conditioning Treatment","Dandruff Treatment","Olapex Breakage Treatment","K18 Treatment","Wig sew in(closure)","Wig sew in(frontal)","Wig revamp(shampooing+curling)","Wig revamp(shampooing+straight)","Wig install ( frontal) sticking","Relax cut & style( pixie)","Shampoo & style (short hair)","Wig straightening or curling of weaves"
    ]},
    {category:"Relaxed Hair", items:[
      "Shampoo+Blow Drying+Straightening","Shampoo+roller setting","Shampoo & Conrows","Relaxer+blowdrying+straightening(salon cream)one","Relaxer+Rollerset one & half(salon cream)","Relaxer+blowdrying+straightening one & half","Relaxer two (salon cream)","Relaxer+blowouts one & half(salon cream)","Relaxer+roller setting(personal cream)","Relaxer+blowdrying+straightening(personal cream)","Own relaxer without shampoo & conditioner","Extra","Trimming","Cutting","Other Con-rows","Conditioning treatment","Dandruff treatment","Olaplex Breakage treatment","K18 Treatment","Traditional sew in","Closure sew in","Tracks glue","Tracks sew in","Relaxed hair ponytail","Relaxer front & back"
    ]},
    {category:"Nails", items:[
      "Pedicure & No polish","Pedicure + Regular polish","Pedicure + Gel polish","Pedicure + Acrylic on toes","Pedicure + stick on","Pedicure stick on + French","Extra for French tips","Jelly Pedicure & Gel polish","Pedicure men","Manicure","Regular Polish","Basic Gel polish","BIAB / Structured Gel polish","Hard Gel + Gel polish","Acrylic Full nails","Acrylic nails on toes","Acrylic on toes refill","Acrylic refill (did full set with us)","Acrylic refill ( did not do full set with us)","Stick on/ Gel polish","Dissolving","Dissolving + Manicure"
    ]},
    {category:"Waxing", items:[
      "Eyebrow Wax","Chin Wax","Chest Wax","Eyebrow shaping","Upper lip","Under arm","Stomach","Full arm","Half arm","Half Legs","Full leg","Bikini area","Full Face","Hollywood wax"
    ]},
    {category:"Spa", items:[
      "Hot stone massage 1hr","Hot stone massage 1hr 30mins","Deep tissue massage 30mins","Deep tissue massage 1hr","Deep tissue massage 1hr 30mins","Swedish massage 30mins","Swedish massage 1hr","Swedish massage 1hr 30mins","Body Scrub","Steam Therapy","Back Treatment","Facials Deep cleanse","Facials Deep cleanse (upgrade)","Facials Rejuvenation","Facials Anti acne","Facials Dermplane (Extra)"
    ]}
  ];

  function groupServicesFromRows(rows){
    const map = new Map();
    rows.forEach(r=>{
      const cat = (r.category || "Other").trim();
      const name = (r.name || "").trim();
      if(!name) return;
      if(!map.has(cat)) map.set(cat, new Set());
      map.get(cat).add(name);
    });
    // convert to array of {category, items:[]}
    return Array.from(map.entries())
      .map(([category,set]) => ({ category, items: Array.from(set).sort((a,b)=>a.localeCompare(b)) }))
      .sort((a,b)=>a.category.localeCompare(b.category));
  }

  function renderChecklist(groups){
    const wrap = document.getElementById("clientServicesGroup");
    if(!wrap) return;
    wrap.innerHTML = "";
    groups.forEach(g=>{
      const details = document.createElement("details");
      details.open = true;
      const summary = document.createElement("summary");
      summary.textContent = g.category;
      details.appendChild(summary);
      g.items.forEach(name=>{
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" value="${name.replace(/"/g,'&quot;')}"> ${name}`;
        details.appendChild(label);
      });
      wrap.appendChild(details);
    });
  }

  function renderServiceFilter(groups){
    const sel = document.getElementById("serviceFilter");
    if(!sel) return;
    const keepFirst = sel.querySelector("option[value='']"); // keep "All Services"
    sel.innerHTML = "";
    if (keepFirst) sel.appendChild(keepFirst);
    const names = [];
    groups.forEach(g => g.items.forEach(n => names.push(n)));
    Array.from(new Set(names))
      .sort((a,b)=>a.localeCompare(b))
      .forEach(name=>{
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        sel.appendChild(opt);
      });
  }

  async function loadServicesFromDB(){
    return new Promise(resolve=>{
      const req = indexedDB.open("SalonDB", 1);
      req.onerror = ()=> resolve([]);
      req.onsuccess = e=>{
        const _db = e.target.result;
        if (!_db.objectStoreNames.contains("services")){
          resolve([]); return;
        }
        const tx = _db.transaction("services","readonly");
        const store = tx.objectStore("services");
        const out = [];
        store.openCursor().onsuccess = ev=>{
          const c = ev.target.result;
          if (c){ out.push(c.value); c.continue(); }
          else resolve(out);
        };
        tx.onerror = ()=> resolve([]);
      };
    });
  }

  async function refreshServicesUI(){
    const rows = await loadServicesFromDB();
    let groups;
    if (rows && rows.length){
      groups = groupServicesFromRows(rows);
    } else {
      groups = DEFAULT_SERVICES;
    }
    renderChecklist(groups);
    renderServiceFilter(groups);
  }

  // Initial load + listen for cross-page updates
  window.addEventListener("DOMContentLoaded", refreshServicesUI);
  if (typeof BroadcastChannel !== "undefined"){
    const bc = new BroadcastChannel("servicesChanged");
    bc.onmessage = (msg)=> {
      if (msg?.type === "refresh-services") refreshServicesUI();
    };
  }
</script>

<!-- Page-local filtering (scope + clickable cards) -->
<script>
  // Helpers
  function todayStr() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  // State
  let CLIENTS_SCOPE = 'today';     // 'today' | 'all'
  let CARD_FILTER   = 'total';     // 'total' | 'returning' | 'new' | 'female' | 'male'

  // Apply filters to the already-rendered table rows
  function applyTableFilters() {
    const tbody = document.querySelector('#clientsTable tbody');
    if (!tbody) return;

    const rows = Array.from(tbody.querySelectorAll('tr'));
    const isToday = (dateStr) => (CLIENTS_SCOPE === 'today' ? dateStr === todayStr() : true);

    // Pre-count phones to detect returning/new in the current scope
    const phoneCount = {};
    rows.forEach(tr => {
      const tds = tr.querySelectorAll('td');
      const date = (tds[5]?.textContent || '').trim();
      if (!isToday(date)) return;
      const phone = (tds[1]?.textContent || '').trim();
      phoneCount[phone] = (phoneCount[phone] || 0) + 1;
    });

    rows.forEach(tr => {
      const tds = tr.querySelectorAll('td');
      const gender = (tds[2]?.textContent || '').trim();
      const date   = (tds[5]?.textContent || '').trim();
      const phone  = (tds[1]?.textContent || '').trim();

      let visible = true;

      // Scope first
      if (!isToday(date)) visible = false;

      // Card filter
      if (visible) {
        switch (CARD_FILTER) {
          case 'female': visible = (gender === 'Female'); break;
          case 'male':   visible = (gender === 'Male');   break;
          case 'new':    visible = (phoneCount[phone] === 1); break;
          case 'returning': visible = (phoneCount[phone] > 1); break;
          default: /* total */ break;
        }
      }

      tr.style.display = visible ? '' : 'none';
    });

    // badge text
    const badge = document.getElementById('activeCardFilter');
    const label = CARD_FILTER.charAt(0).toUpperCase() + CARD_FILTER.slice(1);
    badge.textContent = (CARD_FILTER === 'total' ? '' : `Filtered: ${label} (${CLIENTS_SCOPE})`);
  }

  // Re-apply after app.js populates table (and whenever search/filter changes)
  const reapply = () => setTimeout(applyTableFilters, 0);

  // Wire radios + clear
  document.getElementById('clientsScopeToday')?.addEventListener('change', e => {
    if (e.target.checked) { CLIENTS_SCOPE = 'today'; reapply(); }
  });
  document.getElementById('clientsScopeAll')?.addEventListener('change', e => {
    if (e.target.checked) { CLIENTS_SCOPE = 'all'; reapply(); }
  });
  document.getElementById('clearCardFilter')?.addEventListener('click', () => {
    CARD_FILTER = 'total';
    document.getElementById('clientSearchInput').value = '';
    document.getElementById('serviceFilter').value = '';
    // default back to Today
    document.getElementById('clientsScopeToday').checked = true;
    CLIENTS_SCOPE = 'today';
    reapply();
  });

  // Make cards clickable
  document.querySelectorAll('.summary-card').forEach(btn => {
    btn.addEventListener('click', () => {
      CARD_FILTER = btn.getAttribute('data-card-filter') || 'total';
      reapply();
    });
  });

  // Also reapply when search/service filter changes (so hidden rows stay hidden)
  document.getElementById('clientSearchInput')?.addEventListener('input', reapply);
  document.getElementById('serviceFilter')?.addEventListener('change', reapply);

  // Default selection: Today
  window.addEventListener('DOMContentLoaded', () => {
    const todayRadio = document.getElementById('clientsScopeToday');
    if (todayRadio) todayRadio.checked = true;
    // after app.js renders on page load, run one pass
    setTimeout(applyTableFilters, 250);
  });

  // Re-apply again a moment later (covers slower IndexedDB renders)
  window.addEventListener('load', () => setTimeout(applyTableFilters, 600));
</script>

</body>
</html>
