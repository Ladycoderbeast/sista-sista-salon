<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Notepad | Sista Sista Salon & Spa</title>

  <script src="auth.js"></script>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="assets/icons/icon-192.png" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <style>
    .form-card{max-width:420px;margin:40px auto 18px;background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:16px}
    body.dark .form-card{background:#222;color:#fff;border-color:#333}
    .form-card h3{margin:4px 0 12px}
    .form-card input[type="text"],.form-card input[type="number"],.form-card input[type="file"],.form-card select{width:100%;padding:10px 12px;margin:6px 0;border-radius:8px;border:1px solid #dcdcdc;outline:none;font-size:14px}
    body.dark .form-card input,body.dark .form-card select{background:#333;color:#fff;border-color:#555}
    .btn{width:100%;background:#000;color:#fff;border:none;border-radius:8px;padding:10px 14px;cursor:pointer;font-weight:600}

    .services-checklist{max-height:260px;overflow:auto;border:1px solid #ddd;padding:10px;border-radius:10px;background:#fafafa;margin-top:6px}
    body.dark .services-checklist{background:#2a2a2a;border-color:#444}
    .services-checklist details{margin:6px 0}
    .services-checklist summary{cursor:pointer;font-weight:600}
    .services-checklist label{display:block;margin:6px 0}

    .table-wrapper{width:100%;padding:0 20px 40px;box-sizing:border-box}
    .clients-table{width:100%;border-collapse:collapse;table-layout:fixed}
    .clients-table th,.clients-table td{border:1px solid #ddd;padding:10px 12px;text-align:left;font-size:14px;white-space:normal;word-break:break-word}
    .clients-table th{background:#000;color:#fff;font-weight:700}
    body.dark .clients-table th{background:#111}
    body.dark .clients-table td,body.dark .clients-table th{border-color:#333}
    .delete-btn{background:#000;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
    .dashboard-header{padding:12px 20px;display:flex;justify-content:flex-end}
    .theme-toggle-wrapper{display:flex;align-items:center;gap:8px}
  </style>
</head>
<body>
<script>
  const user = JSON.parse(localStorage.getItem("loggedUser"));
  if (!user || !user.role) { window.location.href = "index.html"; }
</script>

<div class="dashboard-container">
  <aside class="sidebar">
    <div class="sidebar-logo">
      <img src="assets/sista-sista-logo.png" alt="Sista Sista Logo" />
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
      <a href="clients.html"><i class="fas fa-users"></i> Clients</a>
      <a href="services.html"><i class="fas fa-scissors"></i> Services</a>
      <a href="notepad.html" class="active"><i class="fas fa-note-sticky"></i> Notepad</a>
      <a href="reservations.html"><i class="fas fa-calendar-check"></i> Bookings</a>
      <a href="reports.html"><i class="fas fa-chart-line"></i> Reports</a>
      <a href="revenue.html"><i class="fa fa-table"></i> Revenue Summary</a>
      <a href="index.html"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </nav>
  </aside>

  <main class="main-content">
    <div class="dashboard-header">
      <div class="theme-toggle-wrapper">
        <span>Dark Theme</span>
        <label class="theme-switch">
          <input type="checkbox" id="toggleDark" />
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <section class="form-card">
      <h3>Add Entry</h3>

      <input type="text" id="npName" placeholder="Full Name" required />
      <input type="text" id="npPhone" placeholder="Phone Number" required />

      <label style="font-weight:600; margin-top:4px;">Services (pick one or more)</label>
      <div id="npServicesGroup" class="services-checklist" role="group" aria-label="Services">
        <!-- Filled from IndexedDB; fallback injected by JS if none -->
      </div>

      <input type="text" id="npDate" placeholder="Select Date" />
      <input type="text" id="npTime" placeholder="Select Time" />

      <button class="btn" id="btnSave" type="button">Save</button>
    </section>

    <section class="table-wrapper">
      <table class="clients-table" id="npTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>Services</th>
            <th>Date</th>
            <th>Time</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody><!-- rows injected --></tbody>
      </table>
    </section>
  </main>
</div>

<script>
  /* ========== Theme toggle ========== */
  const darkToggle = document.getElementById("toggleDark");
  if (localStorage.getItem("theme")==="dark") { document.body.classList.add("dark"); if(darkToggle) darkToggle.checked = true; }
  darkToggle?.addEventListener("change", () => {
    document.body.classList.toggle("dark");
    localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
  });

  /* ========== Pickers ========== */
  flatpickr("#npDate", { dateFormat: "Y-m-d" });
  flatpickr("#npTime", { enableTime: true, noCalendar: true, dateFormat: "h:i K", time_24hr: false });

  /* ========== Services: DB â†’ grouped checklist (with fallback) ========== */
  const FALLBACK_GROUPS = [
    { category:"Natural Hair", items:[
      "Shampoo & Conrow","Detangling Shampoo Blowout","Natural Ponytail Hair No Silk Press","Silk Press",
      "Conditioning Treatment","Dandruff Treatment","Olapex Breakage Treatment","K18 Treatment",
      "Wig sew in(closure)","Wig sew in(frontal)","Wig revamp(shampooing+curling)","Wig revamp(shampooing+straight)",
      "Wig install ( frontal) sticking","Relax cut & style( pixie)","Shampoo & style (short hair)","Wig straightening or curling of weaves"
    ]},
    { category:"Relaxed Hair", items:[
      "Shampoo+Blow Drying+Straightening","Shampoo+roller setting","Shampoo & Conrows",
      "Relaxer+blowdrying+straightening(salon cream)one","Relaxer+Rollerset one & half(salon cream)",
      "Relaxer+blowdrying+straightening one & half","Relaxer two (salon cream)","Relaxer+blowouts one & half(salon cream)",
      "Relaxer+roller setting(personal cream)","Relaxer+blowdrying+straightening(personal cream)",
      "Own relaxer without shampoo & conditioner","Extra","Trimming","Cutting","Other Con-rows",
      "Conditioning treatment","Dandruff treatment","Olaplex Breakage treatment","K18 Treatment","Traditional sew in",
      "Closure sew in","Tracks glue","Tracks sew in","Relaxed hair ponytail","Relaxer front & back"
    ]},
    { category:"Nails", items:[
      "Pedicure & No polish","Pedicure + Regular polish","Pedicure + Gel polish","Pedicure + Acrylic on toes","Pedicure + stick on",
      "Pedicure stick on + French","Extra for French tips","Jelly Pedicure & Gel polish","Pedicure men","Manicure",
      "Regular Polish","Basic Gel polish","BIAB / Structured Gel polish","Hard Gel + Gel polish","Acrylic Full nails",
      "Acrylic nails on toes","Acrylic on toes refill","Acrylic refill (did full set with us)","Acrylic refill ( did not do full set with us)",
      "Stick on/ Gel polish","Dissolving","Dissolving + Manicure"
    ]},
    { category:"Waxing", items:[
      "Eyebrow Wax","Chin Wax","Chest Wax","Eyebrow shaping","Upper lip","Under arm","Stomach","Full arm","Half arm",
      "Half Legs","Full leg","Bikini area","Full Face","Hollywood wax"
    ]},
    { category:"Spa", items:[
      "Hot stone massage 1hr","Hot stone massage 1hr 30mins","Deep tissue massage 30mins","Deep tissue massage 1hr",
      "Deep tissue massage 1hr 30mins","Swedish massage 30mins","Swedish massage 1hr","Swedish massage 1hr 30mins",
      "Body Scrub","Steam Therapy","Back Treatment","Facials Deep cleanse","Facials Deep cleanse (upgrade)",
      "Facials Rejuvenation","Facials Anti acne","Facials Dermplane (Extra)"
    ]}
  ];

  function renderChecklist(targetId, groups){
    const host = document.getElementById(targetId);
    host.innerHTML = "";
    groups.forEach(g=>{
      const det = document.createElement("details");
      det.open = true;
      const sum = document.createElement("summary");
      sum.textContent = g.category;
      det.appendChild(sum);
      (g.items || []).forEach(name=>{
        const lbl = document.createElement("label");
        lbl.innerHTML = `<input type="checkbox" value="${name}"> ${name}`;
        det.appendChild(lbl);
      });
      host.appendChild(det);
    });
  }

  function readAllServicesFromDB(){
    return new Promise((resolve)=>{
      const req = indexedDB.open("SalonDB",1);
      req.onerror = () => resolve([]);
      req.onsuccess = (ev)=>{
        const idb = ev.target.result;
        if (!idb.objectStoreNames.contains("services")) { resolve([]); return; }
        const tx = idb.transaction("services","readonly");
        const store = tx.objectStore("services");
        const getAll = store.getAll();
        getAll.onsuccess = ()=> resolve(getAll.result || []);
        getAll.onerror  = ()=> resolve([]);
      };
    });
  }

  async function buildServicesChecklist(){
    const rows = await readAllServicesFromDB();
    if (!rows.length) { renderChecklist("npServicesGroup", FALLBACK_GROUPS); return; }
    const map = new Map();
    rows.forEach(r=>{
      const cat=(r.category||"Other").trim();
      const name=(r.name||"").trim();
      if(!name) return;
      if(!map.has(cat)) map.set(cat,new Set());
      map.get(cat).add(name);
    });
    const groups = Array.from(map.entries())
      .sort((a,b)=>a[0].localeCompare(b[0]))
      .map(([category,set])=>({category,items:Array.from(set).sort((a,b)=>a.localeCompare(b))}));
    renderChecklist("npServicesGroup", groups);
  }

  // Live update if Services change in another tab/page
  (function wireServicesBroadcast(){
    if (typeof BroadcastChannel === "undefined") return;
    const ch = new BroadcastChannel("services");
    ch.onmessage = (e)=>{
      if (e?.data?.type === "services-updated") buildServicesChecklist();
    };
  })();

  /* ========== Notepad DB ========== */
  let npDB;
  const req = indexedDB.open("SalonNotepadDB", 1);
  req.onupgradeneeded = (e) => {
    npDB = e.target.result;
    if (!npDB.objectStoreNames.contains("notepad_entries")) {
      npDB.createObjectStore("notepad_entries", { keyPath: "id", autoIncrement: true });
    }
  };
  req.onsuccess = (e) => { npDB = e.target.result; loadEntries(); };
  req.onerror  = (e) => console.error("Notepad DB error:", e.target.error);

  /* ========== Helpers ========== */
  function getSelectedServices(){
    return Array.from(document.querySelectorAll('#npServicesGroup input[type="checkbox"]:checked'))
      .map(cb=>cb.value.trim()).filter(Boolean);
  }
  function clearSelectedServices(){
    document.querySelectorAll('#npServicesGroup input[type="checkbox"]').forEach(cb=>cb.checked=false);
  }
  function clearForm(){
    document.getElementById("npName").value="";
    document.getElementById("npPhone").value="";
    document.getElementById("npDate").value="";
    document.getElementById("npTime").value="";
    clearSelectedServices();
  }

  /* ========== CRUD ========== */
  function saveEntry(){
    if (!npDB) return alert("DB not ready yet.");
    const name = document.getElementById("npName").value.trim();
    const phone = document.getElementById("npPhone").value.trim();
    const services = getSelectedServices();
    const date = document.getElementById("npDate").value.trim();
    const time = document.getElementById("npTime").value.trim();

    if (!name || !phone || services.length===0 || !date || !time) {
      alert("Please fill all fields and select at least one service.");
      return;
    }

    const tx = npDB.transaction("notepad_entries","readwrite");
    tx.objectStore("notepad_entries").add({ name, phone, services, date, time, createdAt: Date.now() });
    tx.oncomplete = () => { clearForm(); loadEntries(); };
  }
  document.getElementById("btnSave").addEventListener("click", saveEntry);

  function loadEntries(){
    const tbody = document.querySelector("#npTable tbody");
    tbody.innerHTML = "";
    const tx = npDB.transaction("notepad_entries","readonly");
    tx.objectStore("notepad_entries").openCursor().onsuccess = (e)=>{
      const cursor = e.target.result;
      if (cursor){
        const v = cursor.value;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${v.name}</td>
          <td>${v.phone}</td>
          <td>${(v.services||[]).join(", ")}</td>
          <td>${v.date||""}</td>
          <td>${v.time||""}</td>
          <td><button class="delete-btn" onclick="deleteEntry(${v.id})">Delete</button></td>
        `;
        tbody.appendChild(tr);
        cursor.continue();
      }
    };
  }
  window.loadEntries = loadEntries;

  function deleteEntry(id){
    const tx = npDB.transaction("notepad_entries","readwrite");
    tx.objectStore("notepad_entries").delete(id);
    tx.oncomplete = () => loadEntries();
  }
  window.deleteEntry = deleteEntry;

  /* ========== Init ========== */
  document.addEventListener("DOMContentLoaded", async ()=>{
    await buildServicesChecklist();
  });
</script>
</body>
</html>
