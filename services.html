<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Services | Sista Sista Salon & Spa</title>
  <script src="auth.js"></script>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="icon" href="assets/icons/icon-192.png" type="image/png">

  <style>
    .services-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;margin-top:18px}
    .service-card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .service-card h3{margin:0 0 10px;font-size:20px}
    .service-list{list-style:disc;margin:0;padding-left:20px}
    .service-item{display:flex;align-items:center;gap:8px;margin:6px 0}
    .service-name{flex:1;line-height:1.3}
    .icon-btn{background:none;border:none;cursor:pointer;padding:6px;border-radius:8px}
    .icon-btn:hover{background:#f2f2f2}
    .add-row{display:flex;gap:8px;margin-top:12px}
    .add-row input{flex:1;padding:8px;border-radius:8px;border:1px solid #ddd}
    .add-row button{padding:8px 12px}

    .ro-note{font-size:12px;color:#777;margin-top:8px}
    .toast-message{visibility:hidden;min-width:200px;background:#333;color:#fff;text-align:center;border-radius:8px;padding:14px;position:fixed;z-index:9999;left:50%;transform:translateX(-50%);bottom:30px;font-size:14px;opacity:0;transition:opacity .35s,bottom .35s}
    .toast-message.show{visibility:visible;opacity:1;bottom:60px}

    body.dark .service-card{background:#1f1f1f;color:#f7f7f7;box-shadow:0 2px 6px rgba(255,255,255,.05)}
    body.dark .icon-btn:hover{background:#2a2a2a}
    body.dark .add-row input{background:#161616;color:#f1f1f1;border-color:#333}

    .user-profile { position: relative; display: inline-block; margin-top: 8px; margin-right: 50px; margin-left: 30px; }
    .user-icon { cursor: pointer; color: #000; }
    .user-dropdown { display: none; position: absolute; background-color: white; min-width: 50px; box-shadow: 0 3px 6px rgba(0,0,0,0.2); z-index: 1; border-radius: 8px; padding: 10px; }
    body.dark .user-dropdown { background-color: #444; color: #fff; }
  </style>
</head>
<body>
<script>
  // Require login
  const _user = JSON.parse(localStorage.getItem("loggedUser"));
  if(!_user || !_user.role){ window.location.href = "index.html"; }
</script>

<div class="dashboard-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <img src="assets/sista-sista-logo.png" alt="Sista Sista Logo" />
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
      <a href="clients.html"><i class="fas fa-users"></i> Clients</a>
      <a href="services.html" class="active"><i class="fas fa-scissors"></i> Services</a>
      <a href="notepad.html"><i class="fas fa-note-sticky"></i> Notepad</a>
      <a href="reviews.html"><i class="fa fa-comments"></i> Reviews</a>
      <a href="reservations.html"><i class="fas fa-calendar-check"></i> Bookings</a>
      <a href="reports.html"><i class="fas fa-chart-line"></i> Reports</a>
      <a href="revenue.html" class="active"><i class="fa fa-table"></i> Revenue Summary</a>
      <a href="index.html"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <div class="dashboard-header">
      <div class="theme-toggle-wrapper">
        <span>Dark Theme</span>
        <label class="theme-switch">
          <input type="checkbox" id="toggleDark" />
          <span class="slider"></span>
        </label>
      </div>
      <div class="user-profile">
        <div class="user-icon" id="userIcon">
          <i class="fas fa-user-circle fa-2x"></i>
        </div>
        <div class="user-dropdown" id="userDropdown">
          <p id="loggedInUser">Loading...</p>
          <button onclick="logout()" style="margin-top:10px;background:#000;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;">Logout</button>
        </div>
      </div>
    </div>

    <div class="dashboard-body">
      <h2>Services</h2>

      <!-- Admin-only: quick add category -->
      <div id="newCategoryBox" style="display:none;margin:10px 0 6px;">
        <details>
          <summary style="cursor:pointer;font-weight:600">Add a new category</summary>
          <div class="add-row" style="margin-top:10px">
            <input id="newCategoryName" type="text" placeholder="Category name e.g. Lashes" />
            <input id="newCategoryService" type="text" placeholder="First service (optional)" />
            <button class="btn" id="addCategoryBtn" type="button">Add Category</button>
          </div>
        </details>
      </div>

      <div id="servicesGrid" class="services-grid"><!-- filled by JS --></div>
      <div id="staffNote" class="ro-note" style="display:none">Read-only mode: staff cannot add or delete services.</div>
    </div>
  </main>
</div>

<!-- Footer -->
<div class="app-footer">
  &copy; 2025 Sista Sista Salon & Spa. All rights reserved.<br/>
  Built by <strong><a href="https://hanatechnologies.org/" target="_blank" style="color: inherit;">H-A-N-A Technologies</a></strong>
</div>

<!-- Tiny toast -->
<div id="toast" class="toast-message"></div>

<!-- Keep user icon behavior -->
<script src="user-icon.js"></script>

<script>
/* ============== Role + Theme ============== */
const role = (_user?.role || "").toString().trim().toLowerCase();
const isAdmin = role === "admin";
document.getElementById("newCategoryBox").style.display = isAdmin ? "block" : "none";
document.getElementById("staffNote").style.display = !isAdmin ? "block" : "none";

const darkToggle = document.getElementById("toggleDark");
if (darkToggle){
  const saved = localStorage.getItem("theme");
  if (saved === "dark"){ document.body.classList.add("dark"); darkToggle.checked = true; }
  darkToggle.addEventListener("change", ()=>{
    document.body.classList.toggle("dark", darkToggle.checked);
    localStorage.setItem("theme", darkToggle.checked ? "dark" : "light");
  });
}

function logout(){
  sessionStorage.removeItem("sista_session");
  localStorage.removeItem("role");
  localStorage.removeItem("username");
  localStorage.removeItem("loggedUser");
  window.location.replace("index.html");
}

function showToast(msg){
  const t = document.getElementById("toast");
  if(!t) return;
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2200);
}

/* ============== DB + Seed ============== */
let SDB;
const DEFAULT_CATEGORIES = [
  {category:"Natural Hair", services:[
    "Shampoo & Conrow","Detangling Shampoo Blowout","Natural Ponytail Hair No Silk Press","Silk Press",
    "Conditioning Treatment","Dandruff Treatment","Olapex Breakage Treatment","K18 Treatment",
    "Wig sew in(closure)","Wig sew in(frontal)","Wig revamp(shampooing+curling)","Wig revamp(shampooing+straight)",
    "Wig install ( frontal) sticking","Relax cut & style( pixie)","Shampoo & style (short hair)","Wig straightening or curling of weaves"
  ]},
  {category:"Relaxed Hair", services:[
    "Shampoo+Blow Drying+Straightening","Shampoo+roller setting","Shampoo & Conrows",
    "Relaxer+blowdrying+straightening(salon cream)one","Relaxer+Rollerset one & half(salon cream)",
    "Relaxer+blowdrying+straightening one & half","Relaxer two (salon cream)","Relaxer+blowouts one & half(salon cream)",
    "Relaxer+roller setting(personal cream)","Relaxer+blowdrying+straightening(personal cream)",
    "Own relaxer without shampoo & conditioner","Extra","Trimming","Cutting","Other Con-rows",
    "Conditioning treatment","Dandruff treatment","Olaplex Breakage treatment","K18 Treatment",
    "Traditional sew in","Closure sew in","Tracks glue","Tracks sew in","Relaxed hair ponytail","Relaxer front & back"
  ]},
  {category:"Nails", services:[
    "Pedicure & No polish","Pedicure + Regular polish","Pedicure + Gel polish","Pedicure + Acrylic on toes",
    "Pedicure + stick on","Pedicure stick on + French","Extra for French tips","Jelly Pedicure & Gel polish",
    "Pedicure men","Manicure","Regular Polish","Basic Gel polish","BIAB / Structured Gel polish","Hard Gel + Gel polish",
    "Acrylic Full nails","Acrylic nails on toes","Acrylic on toes refill","Acrylic refill (did full set with us)",
    "Acrylic refill ( did not do full set with us)","Stick on/ Gel polish","Dissolving","Dissolving + Manicure"
  ]},
  {category:"Waxing", services:[
    "Eyebrow Wax","Chin Wax","Chest Wax","Eyebrow shaping","Upper lip","Under arm","Stomach",
    "Full arm","Half arm","Half Legs","Full leg","Bikini area","Full Face","Hollywood wax"
  ]},
  {category:"Spa", services:[
    "Hot stone massage 1hr","Hot stone massage 1hr 30mins","Deep tissue massage 30mins","Deep tissue massage 1hr",
    "Deep tissue massage 1hr 30mins","Swedish massage 30mins","Swedish massage 1hr","Swedish massage 1hr 30mins",
    "Body Scrub","Steam Therapy","Back Treatment","Facials Deep cleanse","Facials Deep cleanse (upgrade)",
    "Facials Rejuvenation","Facials Anti acne","Facials Dermplane (Extra)"
  ]}
];

function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open("SalonDB",1);
    req.onerror = e => { console.error("IDB open error", e); reject(e.target.error); };
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if(!db.objectStoreNames.contains("clients")) db.createObjectStore("clients",{keyPath:"id",autoIncrement:true});
      if(!db.objectStoreNames.contains("visits")) db.createObjectStore("visits",{keyPath:"id",autoIncrement:true});
      if(!db.objectStoreNames.contains("reservations")) db.createObjectStore("reservations",{keyPath:"id",autoIncrement:true});
      if(!db.objectStoreNames.contains("services")) db.createObjectStore("services",{keyPath:"id",autoIncrement:true});
    };
    req.onsuccess = e => resolve(e.target.result);
  });
}

async function seedIfEmpty(){
  const tx = SDB.transaction("services","readonly");
  const st = tx.objectStore("services");
  const count = await new Promise(res=>{ const c=st.count(); c.onsuccess=()=>res(c.result||0); c.onerror=()=>res(0); });
  if(count>0) return;

  const wtx = SDB.transaction("services","readwrite");
  const wst = wtx.objectStore("services");
  DEFAULT_CATEGORIES.forEach(g => g.services.forEach(name => wst.add({category:g.category, name})));
  return new Promise(res => { wtx.oncomplete = ()=>res(); });
}

/* ============== Render ============== */
function getAllServices(){
  return new Promise(res=>{
    const arr=[];
    const tx = SDB.transaction("services","readonly");
    tx.objectStore("services").openCursor().onsuccess = e=>{
      const cur = e.target.result;
      if(cur){ arr.push(cur.value); cur.continue(); } else { res(arr); }
    };
  });
}

const CATEGORY_ORDER = ["Natural Hair","Relaxed Hair","Nails","Waxing","Spa"];
function ordered(keys){
  const rest = keys.filter(k=>!CATEGORY_ORDER.includes(k)).sort((a,b)=>a.localeCompare(b));
  return CATEGORY_ORDER.filter(k=>keys.includes(k)).concat(rest);
}

async function render(){
  const grid = document.getElementById("servicesGrid");
  grid.innerHTML = "";

  let all;
  try { all = await getAllServices(); }
  catch (e){ console.error(e); all = []; }

  const byCat = {};
  all.forEach(s => { (byCat[s.category] ??= []).push(s); });

  const cats = ordered(Object.keys(byCat));
  if(cats.length === 0){
    const empty = document.createElement("div");
    empty.textContent = "No services yet. Add a category or services to get started.";
    empty.className = "ro-note";
    grid.appendChild(empty);
    return;
  }

  cats.forEach(cat=>{
    const card = document.createElement("div");
    card.className = "service-card";

    const h = document.createElement("h3");
    h.textContent = cat;
    card.appendChild(h);

    const ul = document.createElement("ul");
    ul.className = "service-list";

    (byCat[cat]||[]).forEach(svc=>{
      const li = document.createElement("li");
      li.className = "service-item";
      li.innerHTML = `
        <span class="service-name">${svc.name}</span>
        ${isAdmin ? `<button class="icon-btn" title="Delete" onclick="deleteService(${svc.id})"><i class="fas fa-trash"></i></button>` : ``}
      `;
      ul.appendChild(li);
    });

    card.appendChild(ul);

    if(isAdmin){
      const addRow = document.createElement("div");
      addRow.className = "add-row";
      addRow.innerHTML = `
        <input type="text" placeholder="Add a new service…" />
        <button class="btn" type="button">Add</button>
      `;
      const input = addRow.querySelector("input");
      addRow.querySelector("button").addEventListener("click", ()=> addService(cat, input.value.trim(), input));
      card.appendChild(addRow);
    }

    grid.appendChild(card);
  });
}

/* ============== Actions ============== */
function addService(category, name, inputEl){
  if(!name) return;
  const tx = SDB.transaction("services","readwrite");
  tx.objectStore("services").add({category, name});
  tx.oncomplete = ()=>{
    inputEl && (inputEl.value = "");
    showToast("Service added");
    render();
    svcChannel?.postMessage({type:"servicesUpdated"});
  };
}

function deleteService(id){
  const tx = SDB.transaction("services","readwrite");
  tx.objectStore("services").delete(Number(id));
  tx.oncomplete = ()=>{
    showToast("Service deleted");
    render();
    svcChannel?.postMessage({type:"servicesUpdated"});
  };
}
window.deleteService = deleteService;

document.getElementById("addCategoryBtn")?.addEventListener("click", ()=>{
  const cat = document.getElementById("newCategoryName").value.trim();
  const first = document.getElementById("newCategoryService").value.trim();
  if(!cat){ alert("Enter a category name"); return; }
  const tx = SDB.transaction("services","readwrite");
  const st = tx.objectStore("services");
  if(first) st.add({category:cat, name:first});
  tx.oncomplete = ()=>{
    document.getElementById("newCategoryName").value="";
    document.getElementById("newCategoryService").value="";
    showToast("Category added");
    render();
    svcChannel?.postMessage({type:"servicesUpdated"});
  };
});

/* ============== Cross-tab sync ============== */
let svcChannel;
if(typeof BroadcastChannel !== "undefined"){
  svcChannel = new BroadcastChannel("services");
  svcChannel.onmessage = (e)=>{ if(e.data?.type==="servicesUpdated") render(); };
}

/* ============== Init ============== */
(async function init(){
  try{
    SDB = await openDB();
    await seedIfEmpty();
    await render();
  }catch(e){
    console.error("Services page failed to init:", e);
    const grid = document.getElementById("servicesGrid");
    grid.innerHTML = `<div class="ro-note">Could not load services. Please reload the page.</div>`;
  }
})();
</script>
</body>
</html>
